<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analizador de Complejidad Operacional - Desconexiones Programadas</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --txt: #e5e7eb;
      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --blue: #3b82f6;
      --border: #334155;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, Segoe UI, Roboto, Arial, sans-serif; background: linear-gradient(180deg, #0b1220, #0f172a 35%); color: var(--txt); }
    .wrap { max-width: 1480px; margin: 0 auto; padding: 18px; }
    h1 { margin: 0 0 8px; font-size: 24px; }
    p.muted { color: var(--muted); margin-top: 0; }
    .grid { display: grid; grid-template-columns: 1.15fr 1fr; gap: 14px; }
    .panel { background: rgba(17,24,39,.92); border: 1px solid var(--border); border-radius: 16px; padding: 14px; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
    .panel h2 { margin: 0 0 10px; font-size: 16px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    input[type="file"], button, select, input[type="number"], input[type="text"] { background: #0b1220; border: 1px solid var(--border); color: var(--txt); border-radius: 10px; padding: 8px 10px; font-size: 13px; }
    button { cursor: pointer; }
    button.primary { background: var(--blue); border-color: #2563eb; }
    button:hover { filter: brightness(1.05); }
    .cards { margin-top: 12px; display: grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap: 10px; }
    .card { background: #0b1220; border: 1px solid var(--border); border-radius: 14px; padding: 10px; min-height: 78px; }
    .card .k { color: var(--muted); font-size: 12px; }
    .card .v { font-size: 22px; font-weight: 700; margin-top: 3px; }
    .pill { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--border); background: #0b1220; }
    .pill.ok { color: #bbf7d0; border-color: rgba(16,185,129,.45); background: rgba(16,185,129,.12); }
    .pill.warn { color: #fde68a; border-color: rgba(245,158,11,.45); background: rgba(245,158,11,.12); }
    .pill.bad { color: #fecaca; border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.12); }
    .pill.info { color: #bfdbfe; border-color: rgba(59,130,246,.45); background: rgba(59,130,246,.12); }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .weights { display: grid; grid-template-columns: repeat(2, minmax(180px, 1fr)); gap: 8px; }
    .field { background: #0b1220; border: 1px solid var(--border); border-radius: 10px; padding: 8px; }
    .field label { display: block; color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .field input, .field select { width: 100%; }
    .stats-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .stats-item { background: #0b1220; border: 1px solid var(--border); border-radius: 10px; padding: 8px; font-size: 13px; }
    .stats-item span { color: var(--muted); display: block; font-size: 12px; }
    .table-wrap { overflow: auto; max-height: 420px; border-radius: 12px; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #243042; text-align: left; white-space: nowrap; }
    th { position: sticky; top: 0; background: #0b1220; z-index: 1; font-size: 12px; color: var(--muted); }
    tr:hover td { background: rgba(59,130,246,.06); }
    .small { font-size: 12px; color: var(--muted); }
    .log { white-space: pre-wrap; background: #0b1220; border: 1px solid var(--border); border-radius: 10px; padding: 10px; min-height: 100px; font-size: 13px; color: #cbd5e1; }
    .bar { height: 10px; background: #0b1220; border-radius: 999px; border: 1px solid var(--border); overflow: hidden; margin-top: 6px; }
    .bar > div { height: 100%; background: linear-gradient(90deg, #22c55e, #f59e0b, #ef4444); }
    .footer { margin-top: 10px; color: var(--muted); font-size: 12px; }
    .section-title { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .subgrid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .mini { font-size: 11px; color: var(--muted); }
    @media (max-width: 1100px) {
      .grid, .two-col, .subgrid { grid-template-columns: 1fr; }
      .cards { grid-template-columns: repeat(2, minmax(140px, 1fr)); }
      .weights { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Analizador de Complejidad Operacional (Desconexiones Programadas)</h1>
    <p class="muted">Sube tu reporte <b>.xls</b> (Excel XML / SpreadsheetML) y obtén complejidad del día + <b>semáforo por CCD y por Zonal</b>. Todo corre localmente en tu navegador (sin Python / sin instalaciones).</p>

    <div class="grid">
      <section class="panel">
        <h2>1) Cargar reporte</h2>
        <div class="row">
          <input id="fileInput" type="file" accept=".xls,.xml" />
          <button id="btnProcesar" class="primary">Procesar archivo</button>
          <button id="btnRecalcular">Recalcular</button>
          <button id="btnExportar" disabled>Exportar CSV</button>
        </div>
        <div class="footer">Hoja esperada: <b>Ordenes programadas para el per</b>. Soporta el formato XML (.xls SpreadsheetML) como tu reporte actual.</div>

        <div class="cards">
          <div class="card"><div class="k">Fecha trabajo</div><div class="v" id="cFecha">-</div></div>
          <div class="card"><div class="k">Órdenes día</div><div class="v" id="cTotal">0</div></div>
          <div class="card"><div class="k">ICO total</div><div class="v" id="cIcoTotal">0</div></div>
          <div class="card"><div class="k">ICO promedio</div><div class="v" id="cIcoProm">0</div></div>
          <div class="card"><div class="k">Pendientes</div><div class="v" id="cPend">0</div></div>
          <div class="card"><div class="k">Normales</div><div class="v" id="cNorm">0</div></div>
          <div class="card"><div class="k">Canceladas</div><div class="v" id="cCanc">0</div></div>
          <div class="card"><div class="k">Pico de presión</div><div class="v" id="cPeak">-</div></div>
        </div>

        <div style="margin-top:12px;" class="two-col">
          <div class="panel" style="padding:10px;">
            <div class="row" style="justify-content:space-between; width:100%;">
              <b>Semáforo general del día</b>
              <span id="badgeSemaforo" class="pill info">Sin calcular</span>
            </div>
            <div class="bar"><div id="barSemaforo" style="width:0%"></div></div>
            <div class="small" id="txtSemaforo" style="margin-top:8px;">Sube un reporte para obtener evaluación.</div>
          </div>
          <div class="panel" style="padding:10px;">
            <b>Resumen automático</b>
            <div id="logResumen" class="log" style="margin-top:8px;">Sin datos.</div>
          </div>
        </div>
      </section>

      <section class="panel">
        <h2>2) Configuración de pesos (ajustable)</h2>
        <div class="weights">
          <div class="field"><label>PT Tipo A</label><input id="wTipoA" type="number" step="0.1" value="8" /></div>
          <div class="field"><label>PT Tipo B</label><input id="wTipoB" type="number" step="0.1" value="6" /></div>
          <div class="field"><label>PT Tipo C</label><input id="wTipoC" type="number" step="0.1" value="4" /></div>
          <div class="field"><label>PT Tipo D</label><input id="wTipoD" type="number" step="0.1" value="2" /></div>
          <div class="field"><label>Peso por paso (Q pasos)</label><input id="wPaso" type="number" step="0.01" value="0.15" /></div>
          <div class="field"><label>Máx pasos considerados</label><input id="wPasoCap" type="number" step="1" value="35" /></div>
          <div class="field"><label>Penalización fuera de plazo</label><input id="wFueraPlazo" type="number" step="0.1" value="2" /></div>
          <div class="field"><label>Penalización cancelada</label><input id="wCancelada" type="number" step="0.1" value="3" /></div>
          <div class="field"><label>Duración >=6h</label><input id="wDur6" type="number" step="0.1" value="0.5" /></div>
          <div class="field"><label>Duración >=8h</label><input id="wDur8" type="number" step="0.1" value="1.5" /></div>
          <div class="field"><label>Duración >=10h</label><input id="wDur10" type="number" step="0.1" value="2.5" /></div>
          <div class="field"><label>Clientes 1-9 / 10-49 / 50+</label><input id="wClientes" type="text" value="1,2,3" /></div>
          <div class="field"><label>Umbral Media (ICO orden)</label><input id="thrMedia" type="number" step="0.1" value="8" /></div>
          <div class="field"><label>Umbral Alta (ICO orden)</label><input id="thrAlta" type="number" step="0.1" value="13" /></div>
        </div>
        <div class="footer">Recalibra con tu experiencia real. Tu regla actual (Tipo A más complejo, D menos complejo) ya viene incorporada.</div>
      </section>
    </div>

    <section class="panel" style="margin-top:14px;">
      <div class="section-title">
        <h2 style="margin:0;">3) Semáforo por CCD y por Zonal</h2>
        <span class="mini">Pensado para decidir si el despachador necesitará apoyo</span>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="field" style="min-width:260px; flex:1;">
          <label>Agrupación CCD</label>
          <select id="selCCDGroup"></select>
        </div>
        <div class="field" style="min-width:260px; flex:1;">
          <label>Agrupación Zonal</label>
          <select id="selZonalGroup"></select>
        </div>
        <div class="field" style="min-width:220px;">
          <label>Umbral apoyo despachador (stress)</label>
          <input id="thrSupport" type="number" step="1" value="70" />
        </div>
      </div>

      <div class="subgrid" style="margin-top:12px;">
        <div>
          <div class="row" style="justify-content:space-between; margin-bottom:6px;">
            <b>Semáforo por CCD</b>
            <span class="mini" id="ccdMeta">Sin datos</span>
          </div>
          <div class="table-wrap" style="max-height: 360px;">
            <table id="tablaCCD">
              <thead>
                <tr><th>CCD</th><th>Semáforo</th><th>Stress</th><th>Activas</th><th>Pend.</th><th>Alta/Media</th><th>ICO total</th><th>ICO prom</th><th>Pico</th><th>Apoyo</th></tr>
              </thead>
              <tbody><tr><td colspan="10" class="small">Sin datos.</td></tr></tbody>
            </table>
          </div>
        </div>
        <div>
          <div class="row" style="justify-content:space-between; margin-bottom:6px;">
            <b>Semáforo por Zonal</b>
            <span class="mini" id="zonalMeta">Sin datos</span>
          </div>
          <div class="table-wrap" style="max-height: 360px;">
            <table id="tablaZonal">
              <thead>
                <tr><th>Zonal</th><th>Semáforo</th><th>Stress</th><th>Activas</th><th>Pend.</th><th>Alta/Media</th><th>ICO total</th><th>ICO prom</th><th>Pico</th><th>Apoyo</th></tr>
              </thead>
              <tbody><tr><td colspan="10" class="small">Sin datos.</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" style="margin-top:14px;">
      <h2>4) Top órdenes complejas</h2>
      <div class="stats-list">
        <div class="stats-item"><span>Complejidad Alta</span><b id="dAlta">0</b></div>
        <div class="stats-item"><span>Complejidad Media</span><b id="dMedia">0</b></div>
        <div class="stats-item"><span>Complejidad Baja</span><b id="dBaja">0</b></div>
        <div class="stats-item"><span>Ventana pico (30 min)</span><b id="dVentana">-</b></div>
      </div>
      <div style="margin-top:12px" class="table-wrap">
        <table id="tablaTop">
          <thead>
            <tr><th>#</th><th>N°</th><th>Tipo</th><th>Q pasos</th><th>Contexto</th><th>Resultado</th><th>ICO</th><th>Bucket</th><th>Área cobertura</th><th>Descripción</th></tr>
          </thead>
          <tbody><tr><td colspan="10" class="small">Sin datos.</td></tr></tbody>
        </table>
      </div>
    </section>

    <section class="panel" style="margin-top:14px;">
      <h2>5) Vista resumida de órdenes del día</h2>
      <div class="table-wrap" style="max-height: 520px;">
        <table id="tablaAll">
          <thead>
            <tr><th>N°</th><th>Fecha</th><th>Inicio</th><th>Fin</th><th>Tipo</th><th>Q pasos</th><th>Contexto</th><th>Área cobertura</th><th>CCD inferido</th><th>Clientes</th><th>Resultado</th><th>ICO</th><th>Bucket</th><th>Descripción</th></tr>
          </thead>
          <tbody><tr><td colspan="14" class="small">Sin datos.</td></tr></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    const state = { rawFileName: null, params: {}, headers: [], rows: [], results: [] };
    const $ = (id) => document.getElementById(id);
    const log = (msg) => $('logResumen').textContent = msg;
    const parseNumber = (v, f=0) => { const n = Number(String(v ?? '').replace(',', '.')); return Number.isFinite(n) ? n : f; };
    const parseTriplet = (t) => { const p = String(t||'').split(',').map(x => parseNumber(x.trim(),0)); return [p[0]??1,p[1]??2,p[2]??3]; };
    const cleanText = (v) => String(v ?? '').trim();
    const toInt = (v) => { const n = parseInt(String(v ?? '').replace(/[^0-9-]/g,''),10); return Number.isFinite(n) ? n : 0; };

    function getConfig(){
      const [c1,c2,c3] = parseTriplet($('wClientes').value);
      return {
        tipoA: parseNumber($('wTipoA').value,8), tipoB: parseNumber($('wTipoB').value,6), tipoC: parseNumber($('wTipoC').value,4), tipoD: parseNumber($('wTipoD').value,2),
        paso: parseNumber($('wPaso').value,0.15), pasoCap: parseNumber($('wPasoCap').value,35),
        fueraPlazo: parseNumber($('wFueraPlazo').value,2), cancelada: parseNumber($('wCancelada').value,3),
        dur6: parseNumber($('wDur6').value,0.5), dur8: parseNumber($('wDur8').value,1.5), dur10: parseNumber($('wDur10').value,2.5),
        cli1:c1, cli2:c2, cli3:c3,
        thrMedia: parseNumber($('thrMedia').value,8), thrAlta: parseNumber($('thrAlta').value,13),
        thrSupport: parseNumber($('thrSupport').value,70)
      };
    }

    function byLocalName(node, name){ return Array.from(node.children || []).filter(el => el.localName === name); }
    function firstChildByLocalName(node, name){ return Array.from(node.children || []).find(el => el.localName === name) || null; }
    function getAttrAnyNS(el, localName){ if(!el?.attributes) return null; for(const a of Array.from(el.attributes)) if(a.localName===localName) return a.value; return null; }

    function parseSpreadsheetML(text){
      const doc = new DOMParser().parseFromString(text, 'application/xml');
      const err = doc.querySelector('parsererror');
      if (err) throw new Error('No se pudo parsear el archivo como XML. Este HTML soporta .xls XML (SpreadsheetML).');
      const worksheets = Array.from(doc.getElementsByTagName('*')).filter(n => n.localName === 'Worksheet');
      const sheets = {};
      worksheets.forEach(ws => {
        const name = getAttrAnyNS(ws, 'Name') || 'Hoja';
        const table = firstChildByLocalName(ws, 'Table'); if(!table) return;
        const rows = []; let maxCol = 0;
        byLocalName(table,'Row').forEach(rowEl => {
          const rowMap = {}; let cidx = 1;
          byLocalName(rowEl,'Cell').forEach(cellEl => {
            const idxAttr = getAttrAnyNS(cellEl,'Index'); if(idxAttr) cidx = parseInt(idxAttr,10);
            const dataEl = firstChildByLocalName(cellEl,'Data'); rowMap[cidx] = dataEl ? (dataEl.textContent ?? '') : '';
            cidx += 1;
          });
          if (Object.keys(rowMap).length){ const localMax = Math.max(...Object.keys(rowMap).map(Number)); if(localMax>maxCol) maxCol = localMax; }
          rows.push(rowMap);
        });
        sheets[name] = rows.map(r => { const arr = []; for(let i=1;i<=maxCol;i++) arr.push(r[i] ?? ''); return arr; });
      });
      return sheets;
    }

    function getParamsMap(sheetRows){ const out = {}; (sheetRows||[]).forEach(r=>{ const k=(r[0]||'').toString().trim(); if(k) out[k]=r[1]??''; }); return out; }
    function parseDateFlexible(v){ const s=String(v||'').trim(); if(!s) return null; if(/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(0,10); const m=s.match(/^(\d{2})\/(\d{2})\/(\d{4})/); return m ? `${m[3]}-${m[2]}-${m[1]}` : null; }
    function parseTimeMinutes(v){ const m=String(v||'').trim().match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/); return m ? Number(m[1])*60+Number(m[2]) : NaN; }
    function parseDurationHours(v){ const m=String(v||'').trim().match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/); return m ? Number(m[1])+Number(m[2])/60+Number(m[3]||0)/3600 : NaN; }

    function inferCCD(row){
      const s = `${row['Cuadrillas']||''} ${row['Área solicitante']||''} ${row['Solicitante']||''}`.toLowerCase();
      if (s.includes('ccd norte')) return 'CCD NORTE';
      if (s.includes('ccd sur')) return 'CCD SUR';
      if (s.includes('ccd')) return 'CCD OTRO';
      return 'SIN CCD INFERIDO';
    }

    function getTipoBaseWeight(tipo,cfg){
      const t = cleanText(tipo).toLowerCase();
      if (t.includes('tipo a')) return cfg.tipoA;
      if (t.includes('tipo b')) return cfg.tipoB;
      if (t.includes('tipo c')) return cfg.tipoC;
      if (t.includes('tipo d')) return cfg.tipoD;
      return 3;
    }
    function getContextWeight(ctx){ const c=cleanText(ctx).toLowerCase(); if(c.includes('roce')||c.includes('obras')) return 2; if(c.includes('mantenimiento')||c.includes('llvv')) return 1.5; return 1; }
    function getTipoProgWeight(tipo){ const t=cleanText(tipo).toLowerCase(); if(t.includes('estándares de calidad')||t.includes('estandares de calidad')) return 2; if(t.includes('ordenanza órgano competente')||t.includes('ordenanza organo competente')) return 1.5; if(t.includes('no reportable a sec')) return 0.5; return 0; }
    function clientesWeight(n,cfg){ if(n>=50) return cfg.cli3; if(n>=10) return cfg.cli2; if(n>=1) return cfg.cli1; return 0; }
    function durWeight(h,cfg){ if(!Number.isFinite(h)) return 0; if(h>=10) return cfg.dur10; if(h>=8) return cfg.dur8; if(h>=6) return cfg.dur6; return 0; }
    function getCircuitoPenalty(c,cfg){ return cleanText(c).toLowerCase().includes('fuera de plazo') ? cfg.fueraPlazo : 0; }
    function getResultadoPenalty(r,cfg){ return cleanText(r).toLowerCase().includes('cancelada') ? -cfg.cancelada : 0; }

    function scoreOrder(row,cfg){
      let s=0;
      s += getTipoBaseWeight(row['Tipo'],cfg);
      s += Math.min(Math.max(0,toInt(row['Q pasos'])), cfg.pasoCap) * cfg.paso;
      s += getContextWeight(row['Tipo de contexto']);
      s += getTipoProgWeight(row['Tipo de desconexión programada']);
      s += clientesWeight(toInt(row['Clientes afectados']), cfg);
      s += durWeight(row.__dur_h, cfg);
      s += getCircuitoPenalty(row['Circuito de aprobación'], cfg);
      s += getResultadoPenalty(row['Resultado'], cfg);
      return Math.max(0, Math.round(s*100)/100);
    }
    function bucket(score,cfg){ if(score>=cfg.thrAlta) return 'Alta'; if(score>=cfg.thrMedia) return 'Media'; return 'Baja'; }

    function inferFechaTrabajo(params, rows){
      const p = params['Fecha de trabajo:'] || params['Fecha trabajo:'] || '';
      const fp = parseDateFlexible(p); if(fp) return fp;
      const counts = {};
      rows.forEach(r => { if(r.__fecha) counts[r.__fecha] = (counts[r.__fecha]||0)+1; });
      return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0]?.[0] || null;
    }

    function computePeak(rows){
      const valid = rows.filter(r => Number.isFinite(r.__ini_m) && Number.isFinite(r.__fin_m) && !String(r['Resultado']||'').toLowerCase().includes('cancelada'));
      let peak = { minute:null, count:0 };
      for(let m=0;m<1440;m+=30){ let c=0; for(const r of valid){ if(r.__ini_m <= m && r.__fin_m > m) c++; } if(c>peak.count) peak = { minute:m, count:c }; }
      return peak;
    }
    function mmToHHMM(m){ if(!Number.isFinite(m)) return 'N/D'; return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`; }

    function semaforoFromRows(rows){
      const activas = rows.filter(r => !String(r['Resultado']||'').toLowerCase().includes('cancelada'));
      if(!activas.length) return { label:'Baja', level:'ok', pct:10, text:'No hay órdenes activas relevantes.' };
      const icoTotal = activas.reduce((a,b)=>a+b.__ico,0);
      const icoProm = icoTotal / activas.length;
      const altas = activas.filter(r => r.__bucket==='Alta').length;
      const medias = activas.filter(r => r.__bucket==='Media').length;
      const peak = computePeak(activas);
      const peakFactor = Math.min(20, (peak.count||0)*2.5);
      const volFactor = Math.min(20, activas.length*0.6);
      const stress = Math.min(100, Math.round((icoProm*4.3) + (altas/activas.length)*28 + (medias/activas.length)*10 + peakFactor + volFactor));
      if(stress>=72) return { label:'Alta', level:'bad', pct:stress, text:'Operación exigente: evaluar apoyo, priorización y seguimiento temprano.' };
      if(stress>=42) return { label:'Media', level:'warn', pct:stress, text:'Operación moderada con focos.' };
      return { label:'Baja', level:'ok', pct:stress, text:'Operación manejable.' };
    }

    function parseWorkbookToRows(sheets){
      const paramsSheet = sheets['parámetros'] || sheets['parametros'] || sheets['Parámetros'] || sheets['Parametros'];
      const opsSheet = sheets['Ordenes programadas para el per'];
      if(!opsSheet) throw new Error('No encontré la hoja "Ordenes programadas para el per".');
      if(!paramsSheet) throw new Error('No encontré la hoja "parámetros".');
      const params = getParamsMap(paramsSheet);
      const headers = (opsSheet[1] || []).map(h => cleanText(h));
      const rows = opsSheet.slice(2).filter(r => Array.isArray(r) && r.some(v => cleanText(v) !== '')).map(r => {
        const obj = {};
        headers.forEach((h,i)=> obj[h] = r[i] ?? '');
        obj.__fecha = parseDateFlexible(obj['Fecha']);
        obj.__dur_h = parseDurationHours(obj['Duración de tareas programadas']);
        obj.__ini_m = parseTimeMinutes(obj['Inicio solicitud']);
        obj.__fin_m = parseTimeMinutes(obj['Fin solicitud']);
        obj.__ccd_inferido = inferCCD(obj);
        obj.__zonal_sugerida = cleanText(obj['Área de cobertura']) || 'SIN ZONAL';
        return obj;
      });
      return { params, headers, rows };
    }

    function populateGroupSelectors(){
      const ccdSel = $('selCCDGroup'), zonSel = $('selZonalGroup');
      ccdSel.innerHTML = ''; zonSel.innerHTML = '';
      const special = [
        { key:'__ccd_inferido', label:'CCD inferido (desde Cuadrillas)' },
        { key:'__zonal_sugerida', label:'Zonal sugerida (Área de cobertura)' }
      ];
      const all = [...special, ...(state.headers||[]).map(h => ({ key:h, label:h }))];
      all.forEach(o => {
        const a = document.createElement('option'); a.value=o.key; a.textContent=o.label; ccdSel.appendChild(a);
        const b = document.createElement('option'); b.value=o.key; b.textContent=o.label; zonSel.appendChild(b);
      });
      ccdSel.value = '__ccd_inferido';
      zonSel.value = (state.headers||[]).includes('Área de cobertura') ? 'Área de cobertura' : '__zonal_sugerida';
    }

    function getGroupValue(row,key){ const s = cleanText(row[key]); return s || '(Sin dato)'; }

    function groupSemaforos(rows, groupKey){
      const map = new Map();
      rows.forEach(r=>{ const k=getGroupValue(r,groupKey); if(!map.has(k)) map.set(k,[]); map.get(k).push(r); });
      const out = [];
      for (const [group, grpRows] of map.entries()){
        const activas = grpRows.filter(r => !String(r['Resultado']||'').toLowerCase().includes('cancelada'));
        const pendientes = grpRows.filter(r => String(r['Resultado']||'').toLowerCase().includes('pendiente')).length;
        const altas = activas.filter(r => r.__bucket==='Alta').length;
        const medias = activas.filter(r => r.__bucket==='Media').length;
        const icoTotal = activas.reduce((a,b)=>a+b.__ico,0);
        const icoProm = activas.length ? icoTotal/activas.length : 0;
        const peak = computePeak(activas);
        const sem = semaforoFromRows(grpRows);
        out.push({ group, sem, activas:activas.length, pendientes, altas, medias, icoTotal, icoProm, peakMin:peak.minute, peakCount:peak.count||0 });
      }
      return out.sort((a,b)=>(b.sem.pct-a.sem.pct)||(b.icoTotal-a.icoTotal)||(b.activas-a.activas));
    }

    function pillHtml(label){ const cls = label==='Alta' ? 'bad' : (label==='Media' ? 'warn' : 'ok'); return `<span class="pill ${cls}">${label}</span>`; }
    function escapeHtml(v){ return String(v ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }

    function renderGroupTable(tableId, metaId, groups, cfg){
      const tbody = $(tableId).querySelector('tbody'); tbody.innerHTML = '';
      if(!groups.length){ tbody.innerHTML = '<tr><td colspan="10" class="small">Sin datos.</td></tr>'; $(metaId).textContent='Sin datos'; return; }
      const supportCount = groups.filter(g => g.sem.pct >= cfg.thrSupport || g.sem.label==='Alta').length;
      $(metaId).textContent = `${groups.length} grupos | ${supportCount} con posible apoyo`;
      groups.forEach(g => {
        const tr = document.createElement('tr');
        const apoyo = (g.sem.pct >= cfg.thrSupport || g.sem.label==='Alta') ? 'Evaluar apoyo' : 'Normal';
        tr.innerHTML = `
          <td title="${escapeHtml(g.group)}">${escapeHtml(g.group)}</td>
          <td>${pillHtml(g.sem.label)}</td>
          <td><b>${g.sem.pct}</b></td>
          <td>${g.activas}</td>
          <td>${g.pendientes}</td>
          <td>${g.altas}/${g.medias}</td>
          <td>${g.icoTotal.toFixed(1)}</td>
          <td>${g.icoProm.toFixed(2)}</td>
          <td>${g.peakMin==null ? 'N/D' : `${mmToHHMM(g.peakMin)} (${g.peakCount})`}</td>
          <td><span class="pill ${apoyo==='Evaluar apoyo'?'bad':'ok'}">${apoyo}</span></td>`;
        tbody.appendChild(tr);
      });
    }

    function renderResults(fechaTrabajo, results, cfg){
      const total = results.length;
      const pend = results.filter(r => String(r['Resultado']||'').toLowerCase().includes('pendiente')).length;
      const norm = results.filter(r => String(r['Resultado']||'').toLowerCase().includes('normal')).length;
      const canc = results.filter(r => String(r['Resultado']||'').toLowerCase().includes('cancelada')).length;
      const activas = results.filter(r => !String(r['Resultado']||'').toLowerCase().includes('cancelada'));
      const icoTotal = activas.reduce((a,b)=>a+b.__ico,0);
      const icoProm = activas.length ? icoTotal/activas.length : 0;
      const peak = computePeak(results);
      const altas = results.filter(r=>r.__bucket==='Alta').length;
      const medias = results.filter(r=>r.__bucket==='Media').length;
      const bajas = results.filter(r=>r.__bucket==='Baja').length;

      $('cFecha').textContent = fechaTrabajo || '-'; $('cTotal').textContent = String(total);
      $('cIcoTotal').textContent = icoTotal.toFixed(1); $('cIcoProm').textContent = icoProm.toFixed(2);
      $('cPend').textContent = String(pend); $('cNorm').textContent = String(norm); $('cCanc').textContent = String(canc);
      $('cPeak').textContent = peak.minute == null ? 'N/D' : `${mmToHHMM(peak.minute)} (${peak.count})`;
      $('dAlta').textContent = String(altas); $('dMedia').textContent = String(medias); $('dBaja').textContent = String(bajas);
      $('dVentana').textContent = peak.minute == null ? 'N/D' : `${mmToHHMM(peak.minute)} - ${mmToHHMM(peak.minute+30)} (${peak.count} activas)`;

      const sem = semaforoFromRows(results);
      $('badgeSemaforo').textContent = `Complejidad ${sem.label}`;
      $('badgeSemaforo').className = `pill ${sem.level}`;
      $('barSemaforo').style.width = `${sem.pct}%`;
      $('txtSemaforo').textContent = `${sem.text} (stress score: ${sem.pct}/100)`;

      const ccdGroups = groupSemaforos(results, $('selCCDGroup').value || '__ccd_inferido');
      const zonGroups = groupSemaforos(results, $('selZonalGroup').value || 'Área de cobertura');
      renderGroupTable('tablaCCD','ccdMeta',ccdGroups,cfg);
      renderGroupTable('tablaZonal','zonalMeta',zonGroups,cfg);

      const top = [...results].sort((a,b)=>b.__ico-a.__ico).slice(0,10);
      const tbodyTop = $('tablaTop').querySelector('tbody'); tbodyTop.innerHTML = '';
      if (!top.length) tbodyTop.innerHTML = '<tr><td colspan="10" class="small">Sin datos.</td></tr>';
      top.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(r['N°'])}</td><td>${escapeHtml(r['Tipo'])}</td><td>${escapeHtml(r['Q pasos'])}</td><td>${escapeHtml(r['Tipo de contexto'])}</td><td>${escapeHtml(r['Resultado'])}</td><td><b>${r.__ico.toFixed(2)}</b></td><td>${pillHtml(r.__bucket)}</td><td>${escapeHtml(r['Área de cobertura'])}</td><td title="${escapeHtml(r['Descripción del trabajo'])}">${escapeHtml((r['Descripción del trabajo']||'').slice(0,90))}</td>`;
        tbodyTop.appendChild(tr);
      });

      const tbodyAll = $('tablaAll').querySelector('tbody'); tbodyAll.innerHTML = '';
      if (!results.length) tbodyAll.innerHTML = '<tr><td colspan="14" class="small">Sin datos.</td></tr>';
      [...results].sort((a,b)=>b.__ico-a.__ico).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(r['N°'])}</td><td>${escapeHtml(r['Fecha'])}</td><td>${escapeHtml(r['Inicio solicitud'])}</td><td>${escapeHtml(r['Fin solicitud'])}</td><td>${escapeHtml(r['Tipo'])}</td><td>${escapeHtml(r['Q pasos'])}</td><td>${escapeHtml(r['Tipo de contexto'])}</td><td>${escapeHtml(r['Área de cobertura'])}</td><td>${escapeHtml(r.__ccd_inferido)}</td><td>${escapeHtml(r['Clientes afectados'])}</td><td>${escapeHtml(r['Resultado'])}</td><td><b>${r.__ico.toFixed(2)}</b></td><td>${pillHtml(r.__bucket)}</td><td title="${escapeHtml(r['Descripción del trabajo'])}">${escapeHtml((r['Descripción del trabajo']||'').slice(0,100))}</td>`;
        tbodyAll.appendChild(tr);
      });

      const ccdCrit = ccdGroups.filter(g => g.sem.pct >= cfg.thrSupport || g.sem.label==='Alta').slice(0,3).map(g=>g.group);
      const zonCrit = zonGroups.filter(g => g.sem.pct >= cfg.thrSupport || g.sem.label==='Alta').slice(0,5).map(g=>g.group);
      log([
        `Archivo: ${state.rawFileName || 'N/D'}`,
        `Fecha de trabajo analizada: ${fechaTrabajo || 'N/D'}`,
        `Órdenes del día: ${total} (Pendientes: ${pend}, Normales: ${norm}, Canceladas: ${canc})`,
        `ICO total (sin canceladas): ${icoTotal.toFixed(1)} | ICO promedio: ${icoProm.toFixed(2)} | Semáforo general: ${sem.label} (${sem.pct}/100)`,
        `Pico de presión general: ${peak.minute == null ? 'N/D' : `${mmToHHMM(peak.minute)}-${mmToHHMM(peak.minute+30)} con ${peak.count} activas`}`,
        `CCD con posible apoyo: ${ccdCrit.length ? ccdCrit.join(', ') : 'Ninguno'}`,
        `Zonales con posible apoyo: ${zonCrit.length ? zonCrit.join(', ') : 'Ninguna'}`
      ].join('\n'));

      $('btnExportar').disabled = !results.length;
    }

    function runAnalysis(){
      if(!state.rows.length){ log('Primero carga un archivo.'); return; }
      const cfg = getConfig();
      const fechaTrabajo = inferFechaTrabajo(state.params, state.rows);
      const results = state.rows.filter(r => r.__fecha === fechaTrabajo).map(r => ({ ...r, __ico: scoreOrder(r,cfg), __bucket: bucket(scoreOrder(r,cfg),cfg) }));
      state.results = results;
      renderResults(fechaTrabajo, results, cfg);
    }

    function exportCSV(){
      if(!state.results.length) return;
      const cols = ['N°','Fecha','Inicio solicitud','Fin solicitud','Tipo','Q pasos','Tipo de desconexión programada','Tipo de contexto','Área solicitante','Área de cobertura','Clientes afectados','Resultado','Circuito de aprobación','Descripción del trabajo'];
      const headers = [...cols,'CCD_inferido','ICO_orden','Complejidad'];
      const rows = state.results.map(r => [...cols.map(c=>r[c]??''), r.__ccd_inferido, r.__ico, r.__bucket]);
      const csv = [headers, ...rows].map(arr => arr.map(c => '"' + String(c ?? '').replaceAll('"','""') + '"').join(';')).join('\n');
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `analisis_complejidad_${state.results[0]?.__fecha || 'dia'}.csv`; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1200);
    }

    async function processSelectedFile(){
      const file = $('fileInput').files?.[0];
      if(!file){ log('Selecciona un archivo .xls primero.'); return; }
      state.rawFileName = file.name;
      try {
        const text = await file.text();
        const sheets = parseSpreadsheetML(text);
        const { params, headers, rows } = parseWorkbookToRows(sheets);
        state.params = params; state.headers = headers; state.rows = rows;
        populateGroupSelectors();
        runAnalysis();
      } catch (e) {
        console.error(e);
        log('Error: ' + (e.message || e));
      }
    }

    $('btnProcesar').addEventListener('click', processSelectedFile);
    $('btnRecalcular').addEventListener('click', runAnalysis);
    $('btnExportar').addEventListener('click', exportCSV);
    $('selCCDGroup').addEventListener('change', runAnalysis);
    $('selZonalGroup').addEventListener('change', runAnalysis);
    document.querySelectorAll('input').forEach(inp => inp.addEventListener('keydown', ev => { if(ev.key==='Enter') runAnalysis(); }));
  </script>
</body>
</html>
